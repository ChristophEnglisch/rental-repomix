This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.
The content has been processed where comments have been removed, empty lines have been removed.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
- Pay special attention to the Repository Description. These contain important context and guidelines specific to this project.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/api/**/*.java, rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/**/*.java, rental-backend/src/main/resources/application*.yml
- Files matching these patterns are excluded: **/target/**, **/.idea/**, **/*.iml, **/.git/**, **/*.class, **/test/**, **/package-info.java
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Code comments have been removed from supported file types
- Empty lines have been removed from all files
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<user_provided_header>
Bounded Context: Buchung

⚠️ PARTIAL VIEW - Only adapter layer(s) included. Missing: domain, application. API package always included.
</user_provided_header>

<directory_structure>
rental-backend/
  src/
    main/
      java/
        de/
          cenglisch/
            rentalbackend/
              buchung/
                api/
                  domain/
                    vereinbarungen/
                      TerminAnfrageWurdeGestellt.java
                      TerminVereinbarungsId.java
                      TerminWurdeAbgelehnt.java
                      TerminWurdeBestaetigt.java
                core/
                  adapter/
                    primary/
                      listener/
                        verfuegbarkeiten/
                          MietauftragStorniertEventHandler.java
                          TerminAbgelehntEventHandler.java
                          TerminBestaetigtEventHandler.java
                      rest/
                        regelwerk/
                          BuchungsregelwerkMessage.java
                          BuchungsregelwerkRestAdapter.java
                        vereinbarungen/
                          TerminAnfrageMessage.java
                          TerminVereinbarungMessage.java
                          TerminVereinbarungRestAdapter.java
                          TerminVereinbarungRestMessageMapper.java
                        verfuegbarkeiten/
                          VerfuegbarkeitMessage.java
                          VerfuegbarkeitNotFoundException.java
                          VerfuegbarkeitRestAdapter.java
                          VerfuegbarkeitRestMessageMapper.java
                    secondary/
                      persistence/
                        vereinbarungen/
                          TerminVereinbarungEntity.java
                          TerminVereinbarungJpaRepository.java
                          TerminVereinbarungMapper.java
                          TerminVereinbarungPersistenceAdapter.java
                        verfuegbarkeiten/
                          VerfuegbarkeitsKalendarEntity.java
                          VerfuegbarkeitsKalendarJpaRepository.java
                          VerfuegbarkeitsKalendarMapper.java
                          VerfuegbarkeitsKalendarPersistenceAdapter.java
      resources/
        application-local.yml
        application.yml
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/api/domain/vereinbarungen/TerminAnfrageWurdeGestellt.java">
package de.cenglisch.rentalbackend.buchung.api.domain.vereinbarungen;
import de.cenglisch.rentalbackend.common.domain.DomainEvent;
import de.cenglisch.rentalbackend.common.domain.Zeitraum;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
@org.jmolecules.event.annotation.DomainEvent
public record TerminAnfrageWurdeGestellt(FahrzeugId fahrzeugId, Zeitraum zeitraum) implements DomainEvent {
    @Override
    public int eventVersion() {
        return 1;
    }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/api/domain/vereinbarungen/TerminVereinbarungsId.java">
package de.cenglisch.rentalbackend.buchung.api.domain.vereinbarungen;
import java.util.UUID;
public record TerminVereinbarungsId(String id) {
    public static TerminVereinbarungsId gen() {
        return new TerminVereinbarungsId(UUID.randomUUID().toString());
    }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/api/domain/vereinbarungen/TerminWurdeAbgelehnt.java">
package de.cenglisch.rentalbackend.buchung.api.domain.vereinbarungen;
import de.cenglisch.rentalbackend.common.domain.DomainEvent;
import de.cenglisch.rentalbackend.common.domain.Zeitraum;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
@org.jmolecules.event.annotation.DomainEvent
public record TerminWurdeAbgelehnt(FahrzeugId fahrzeugId, Zeitraum zeitraum) implements DomainEvent {
    @Override
    public int eventVersion() {
        return 1;
    }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/api/domain/vereinbarungen/TerminWurdeBestaetigt.java">
package de.cenglisch.rentalbackend.buchung.api.domain.vereinbarungen;
import de.cenglisch.rentalbackend.common.domain.DomainEvent;
import de.cenglisch.rentalbackend.common.domain.StandortId;
import de.cenglisch.rentalbackend.common.domain.Zeitraum;
import de.cenglisch.rentalbackend.kunde.api.domain.KundenId;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
import java.time.LocalTime;
@org.jmolecules.event.annotation.DomainEvent
public record TerminWurdeBestaetigt(
        TerminVereinbarungsId terminVereinbarungsId,
        KundenId kundenId,
        FahrzeugId fahrzeugId,
        Zeitraum zeitraum,
        StandortId standortId,
        LocalTime abholzeit,
        LocalTime rueckgabezeit
) implements DomainEvent {
    @Override
    public int eventVersion() {
        return 4;
    }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/listener/verfuegbarkeiten/MietauftragStorniertEventHandler.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.listener.verfuegbarkeiten;
import de.cenglisch.rentalbackend.buchung.core.application.verfuegbarkeiten.VerfuegbarkeitApplicationService;
import de.cenglisch.rentalbackend.buchung.core.application.verfuegbarkeiten.ZeitraumFreigeben;
import de.cenglisch.rentalbackend.mietabwicklung.api.domain.mietauftrag.MietauftragWurdeStorniert;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.modulith.events.ApplicationModuleListener;
import org.springframework.stereotype.Component;
@Component
@RequiredArgsConstructor
@Slf4j
public class MietauftragStorniertEventHandler {
    private final VerfuegbarkeitApplicationService verfuegbarkeitApplicationService;
    @ApplicationModuleListener
    public void onMietauftragWurdeStorniert(MietauftragWurdeStorniert event) {
        log.info("===========================================");
        log.info("EVENT HANDLER AUFGERUFEN: MietauftragStorniertEventHandler");
        log.info("Verarbeite MietauftragWurdeStorniert Event fuer Mietauftrag {} und Fahrzeug {} im Zeitraum {}-{}",
            event.mietauftragId().id(),
            event.fahrzeugId().id(),
            event.zeitraum().von(),
            event.zeitraum().bis());
        log.info("===========================================");
        ZeitraumFreigeben command = new ZeitraumFreigeben(
            event.fahrzeugId(),
            event.zeitraum()
        );
        verfuegbarkeitApplicationService.zeitraumFreigeben(command);
        log.info("Event-Verarbeitung abgeschlossen - Zeitraum im Verfuegbarkeitskalender freigegeben");
    }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/listener/verfuegbarkeiten/TerminAbgelehntEventHandler.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.listener.verfuegbarkeiten;
import de.cenglisch.rentalbackend.buchung.api.domain.vereinbarungen.TerminWurdeAbgelehnt;
import de.cenglisch.rentalbackend.buchung.core.application.verfuegbarkeiten.VerfuegbarkeitApplicationService;
import de.cenglisch.rentalbackend.buchung.core.application.verfuegbarkeiten.ZeitraumFreigeben;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.modulith.events.ApplicationModuleListener;
import org.springframework.stereotype.Component;
@Component
@RequiredArgsConstructor
@Slf4j
public class TerminAbgelehntEventHandler {
    private final VerfuegbarkeitApplicationService verfuegbarkeitApplicationService;
    @ApplicationModuleListener
    public void onTerminWurdeAbgelehnt(TerminWurdeAbgelehnt event) {
        log.info("===========================================");
        log.info("EVENT HANDLER AUFGERUFEN: TerminAbgelehntEventHandler");
        log.info("Verarbeite TerminWurdeAbgelehnt Event fuer Fahrzeug {} im Zeitraum {}-{}",
            event.fahrzeugId().id(),
            event.zeitraum().von(),
            event.zeitraum().bis());
        log.info("===========================================");
        ZeitraumFreigeben command = new ZeitraumFreigeben(
            event.fahrzeugId(),
            event.zeitraum()
        );
        verfuegbarkeitApplicationService.zeitraumFreigeben(command);
        log.info("Event-Verarbeitung abgeschlossen");
    }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/listener/verfuegbarkeiten/TerminBestaetigtEventHandler.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.listener.verfuegbarkeiten;
import de.cenglisch.rentalbackend.buchung.api.domain.vereinbarungen.TerminWurdeBestaetigt;
import de.cenglisch.rentalbackend.buchung.core.application.verfuegbarkeiten.VerfuegbarkeitApplicationService;
import de.cenglisch.rentalbackend.buchung.core.application.verfuegbarkeiten.ZeitraumReservieren;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.modulith.events.ApplicationModuleListener;
import org.springframework.stereotype.Component;
@Component
@RequiredArgsConstructor
@Slf4j
public class TerminBestaetigtEventHandler {
    private final VerfuegbarkeitApplicationService verfuegbarkeitApplicationService;
    @ApplicationModuleListener
    public void onTerminWurdeBestaetigt(TerminWurdeBestaetigt event) {
        log.info("===========================================");
        log.info("EVENT HANDLER AUFGERUFEN: TerminBestaetigtEventHandler");
        log.info("Verarbeite TerminWurdeBestaetigt Event fuer Fahrzeug {} im Zeitraum {}-{}",
            event.fahrzeugId().id(),
            event.zeitraum().von(),
            event.zeitraum().bis());
        log.info("===========================================");
        ZeitraumReservieren command = new ZeitraumReservieren(
            event.fahrzeugId(),
            event.zeitraum()
        );
        verfuegbarkeitApplicationService.zeitraumReservieren(command);
        log.info("Event-Verarbeitung abgeschlossen");
    }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/regelwerk/BuchungsregelwerkMessage.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.regelwerk;
import io.swagger.v3.oas.annotations.media.Schema;
@Schema(description = "Regelwerk für Buchungen - definiert die Geschäftsregeln für Terminvereinbarungen")
public record BuchungsregelwerkMessage(
    @Schema(description = "Maximale Mietdauer in Tagen", example = "90")
    int maxMietdauerTage,
    @Schema(description = "Maximale Anzahl offener Anfragen pro Kunde", example = "2")
    int maxOffeneAnfragen,
    @Schema(description = "Kontaktinformation für Langzeitmieten über der maximalen Mietdauer",
            example = "langzeitmiete@express-sportwagen.de")
    String langzeitmieteKontakt
) {}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/regelwerk/BuchungsregelwerkRestAdapter.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.regelwerk;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarung;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminvereinbarungsZeitraum;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
@RestController
@RequestMapping("/api/v1/buchung/regelwerk")
@Tag(name = "Buchungsregelwerk", description = "Abfrage der Geschäftsregeln für Buchungen")
public class BuchungsregelwerkRestAdapter {
    @GetMapping
    @Operation(
        summary = "Buchungsregelwerk abrufen",
        description = "Liefert die aktuellen Geschäftsregeln für Buchungen, " +
            "z.B. maximale Mietdauer, maximale offene Anfragen und Kontaktinformationen.",
        responses = {
            @ApiResponse(
                responseCode = "200",
                description = "Buchungsregelwerk erfolgreich abgerufen",
                content = @Content(
                    mediaType = MediaType.APPLICATION_JSON_VALUE,
                    schema = @Schema(implementation = BuchungsregelwerkMessage.class)
                )
            )
        }
    )
    public BuchungsregelwerkMessage getRegelwerk() {
        return new BuchungsregelwerkMessage(
            TerminvereinbarungsZeitraum.MAX_MIETDAUER_TAGE,
            TerminVereinbarung.MAX_OFFENE_ANFRAGEN,
            TerminvereinbarungsZeitraum.LANGZEITMIETE_KONTAKT
        );
    }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/vereinbarungen/TerminAnfrageMessage.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.vereinbarungen;
import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.time.LocalDate;
import java.time.LocalTime;
public record TerminAnfrageMessage(
  @Schema(description = "Die ID des Fahrzeugs fuer die Terminvereinbarung", example = "f47ac10b-58cc-4372-a567-0e02b2c3d479", requiredMode = Schema.RequiredMode.REQUIRED)
  @NotBlank
  String fahrzeugId,
  @Schema(description = "Der Startdatum des gewünschten Zeitraums", example = "2025-11-01", requiredMode = Schema.RequiredMode.REQUIRED)
  @NotNull
  LocalDate von,
  @Schema(description = "Das Enddatum des gewünschten Zeitraums", example = "2025-11-05", requiredMode = Schema.RequiredMode.REQUIRED)
  @NotNull
  LocalDate bis,
  @Schema(description = "Die ID des Abholstandorts", example = "standort-duesseldorf", requiredMode = Schema.RequiredMode.REQUIRED)
  @NotBlank
  String standortId,
  @Schema(description = "Die gewünschte Abholzeit", example = "10:00", requiredMode = Schema.RequiredMode.NOT_REQUIRED)
  LocalTime abholzeit,
  @Schema(description = "Die gewünschte Rückgabezeit", example = "18:00", requiredMode = Schema.RequiredMode.NOT_REQUIRED)
  LocalTime rueckgabezeit
) {
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/vereinbarungen/TerminVereinbarungMessage.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.vereinbarungen;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarungsStatus;
import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;
import java.time.LocalTime;
public record TerminVereinbarungMessage(
  @Schema(description = "Die ID der Terminvereinbarung", example = "f47ac10b-58cc-4372-a567-0e02b2c3d479")
  String id,
  @Schema(description = "Die ID des Kunden", example = "c1d2e3f4-5678-90ab-cdef-1234567890ab")
  String kundenId,
  @Schema(description = "Die ID des Fahrzeugs", example = "a1b2c3d4-e5f6-7890-abcd-ef1234567890")
  String fahrzeugId,
  @Schema(description = "Der Status der Terminvereinbarung", example = "ANFRAGE_GESTELLT")
  TerminVereinbarungsStatus status,
  @Schema(description = "Der Startdatum des Zeitraums", example = "2025-11-01")
  LocalDate von,
  @Schema(description = "Das Enddatum des Zeitraums", example = "2025-11-05")
  LocalDate bis,
  @Schema(description = "Die ID des Abholstandorts", example = "standort-duesseldorf")
  String standortId,
  @Schema(description = "Die gewünschte Abholzeit", example = "10:00")
  LocalTime abholzeit,
  @Schema(description = "Die gewünschte Rückgabezeit", example = "18:00")
  LocalTime rueckgabezeit
) {
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/vereinbarungen/TerminVereinbarungRestAdapter.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.vereinbarungen;
import de.cenglisch.rentalbackend.buchung.core.application.vereinbarungen.TerminAblehnen;
import de.cenglisch.rentalbackend.buchung.core.application.vereinbarungen.TerminAnfrageStellen;
import de.cenglisch.rentalbackend.buchung.core.application.vereinbarungen.TerminBestaetigen;
import de.cenglisch.rentalbackend.buchung.core.application.vereinbarungen.TerminVereinbarungApplicationService;
import de.cenglisch.rentalbackend.buchung.core.application.vereinbarungen.TerminVereinbarungenAbfragen;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarung;
import de.cenglisch.rentalbackend.buchung.api.domain.vereinbarungen.TerminVereinbarungsId;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarungsStatus;
import de.cenglisch.rentalbackend.common.application.BenutzerKontext;
import de.cenglisch.rentalbackend.kunde.api.domain.KundenId;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.ArraySchema;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ProblemDetail;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestController;
import java.util.Collection;
import java.util.List;
import java.util.Optional;
@RestController
@RequestMapping("/api/v1/terminvereinbarungen")
@RequiredArgsConstructor
@Validated
@Tag(name = "Terminvereinbarungen", description = "Verwaltung von Terminvereinbarungen fuer Fahrzeuge")
public class TerminVereinbarungRestAdapter {
  private final TerminVereinbarungApplicationService terminVereinbarungApplicationService;
  private final BenutzerKontext benutzerKontext;
  @GetMapping
  @Operation(
    summary = "Terminvereinbarungen abfragen",
    description = "Ruft Terminvereinbarungen ab. Mitarbeiter sehen alle, Kunden nur ihre eigenen. " +
      "Optional gefiltert nach Status und/oder Fahrzeug-ID.",
    responses = {
      @ApiResponse(
        responseCode = "200",
        description = "Liste der Terminvereinbarungen",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          array = @ArraySchema(schema = @Schema(implementation = TerminVereinbarungMessage.class))
        )
      ),
      @ApiResponse(
        responseCode = "400",
        description = "Ungültiger Status-Parameter",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      )
    }
  )
  public List<TerminVereinbarungMessage> getTerminvereinbarungen(
    @Parameter(description = "Optional: Filtere nach Status (ANFRAGE_GESTELLT, BESTAETIGT, ABGELEHNT)")
    @RequestParam(required = false) TerminVereinbarungsStatus status,
    @Parameter(description = "Optional: Filtere nach Fahrzeug-ID")
    @RequestParam(required = false) String fahrzeugId
  ) {
    TerminVereinbarungenAbfragen abfrage = new TerminVereinbarungenAbfragen(
        Optional.ofNullable(status),
        Optional.ofNullable(fahrzeugId).map(FahrzeugId::new)
    );
    Collection<TerminVereinbarung> terminvereinbarungen =
        terminVereinbarungApplicationService.terminVereinbarungenAbfragen(abfrage);
    return terminvereinbarungen.stream()
      .map(TerminVereinbarungRestMessageMapper::mapToTerminVereinbarungMessage)
      .toList();
  }
  @GetMapping("/{id}")
  @Operation(
    summary = "Einzelne Terminvereinbarung abrufen",
    description = "Ruft eine spezifische Terminvereinbarung anhand ihrer ID ab. " +
      "Kunden können nur ihre eigenen Vereinbarungen abrufen.",
    responses = {
      @ApiResponse(
        responseCode = "200",
        description = "Terminvereinbarung gefunden",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = TerminVereinbarungMessage.class)
        )
      ),
      @ApiResponse(
        responseCode = "404",
        description = "Terminvereinbarung nicht gefunden",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      )
    }
  )
  public TerminVereinbarungMessage getTerminvereinbarung(@PathVariable String id) {
    TerminVereinbarung terminVereinbarung =
        terminVereinbarungApplicationService.terminVereinbarungLaden(new TerminVereinbarungsId(id));
    return TerminVereinbarungRestMessageMapper.mapToTerminVereinbarungMessage(terminVereinbarung);
  }
  @PostMapping
  @ResponseStatus(HttpStatus.CREATED)
  @Operation(
    summary = "Neue Terminanfrage stellen",
    description = "Erstellt eine neue Terminanfrage fuer ein Fahrzeug. " +
      "Diese Aktion kann nur von Kunden durchgeführt werden.",
    responses = {
      @ApiResponse(
        responseCode = "201",
        description = "Terminanfrage wurde erfolgreich erstellt",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = TerminVereinbarungMessage.class)
        )
      ),
      @ApiResponse(
        responseCode = "400",
        description = "Ungültige Eingabedaten",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      ),
      @ApiResponse(
        responseCode = "401",
        description = "Nicht authentifiziert",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      ),
      @ApiResponse(
        responseCode = "403",
        description = "Keine Berechtigung - nur Kunden dürfen Terminanfragen stellen",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      ),
      @ApiResponse(
        responseCode = "409",
        description = "Fahrzeug ist im gewünschten Zeitraum bereits belegt",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      )
    }
  )
  public TerminVereinbarungMessage postTerminAnfrage(
    @Valid @RequestBody TerminAnfrageMessage terminAnfrageMessage) {
    KundenId kundenId = KundenId.von(benutzerKontext.getKundenId());
    TerminAnfrageStellen command =
      TerminVereinbarungRestMessageMapper.mapToTerminAnfrageStellen(kundenId, terminAnfrageMessage);
    TerminVereinbarung terminVereinbarung =
      terminVereinbarungApplicationService.terminAnfrageStellen(command);
    return TerminVereinbarungRestMessageMapper.mapToTerminVereinbarungMessage(terminVereinbarung);
  }
  @PutMapping("/{id}/bestaetigen")
  @ResponseStatus(HttpStatus.OK)
  @Operation(
    summary = "Terminvereinbarung bestätigen",
    description = "Bestätigt eine bestehende Terminvereinbarung. " +
      "Diese Aktion kann nur von Mitarbeitern durchgeführt werden.",
    responses = {
      @ApiResponse(
        responseCode = "200",
        description = "Terminvereinbarung wurde erfolgreich bestätigt",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = TerminVereinbarungMessage.class)
        )
      ),
      @ApiResponse(
        responseCode = "401",
        description = "Nicht authentifiziert",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      ),
      @ApiResponse(
        responseCode = "403",
        description = "Keine Berechtigung - nur Mitarbeiter dürfen Termine bestätigen",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      ),
      @ApiResponse(
        responseCode = "404",
        description = "Terminvereinbarung nicht gefunden",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      )
    }
  )
  public TerminVereinbarungMessage putTerminBestaetigen(@PathVariable String id) {
    TerminBestaetigen command = new TerminBestaetigen(new TerminVereinbarungsId(id));
    TerminVereinbarung terminVereinbarung =
      terminVereinbarungApplicationService.terminBestaetigen(command);
    return TerminVereinbarungRestMessageMapper.mapToTerminVereinbarungMessage(terminVereinbarung);
  }
  @PutMapping("/{id}/ablehnen")
  @ResponseStatus(HttpStatus.OK)
  @Operation(
    summary = "Terminanfrage ablehnen",
    description = "Lehnt eine Terminanfrage ab. " +
      "Diese Aktion kann nur von Mitarbeitern durchgeführt werden.",
    responses = {
      @ApiResponse(
        responseCode = "200",
        description = "Terminanfrage wurde erfolgreich abgelehnt",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = TerminVereinbarungMessage.class)
        )
      ),
      @ApiResponse(
        responseCode = "401",
        description = "Nicht authentifiziert",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      ),
      @ApiResponse(
        responseCode = "403",
        description = "Keine Berechtigung - nur Mitarbeiter dürfen Terminanfragen ablehnen",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      ),
      @ApiResponse(
        responseCode = "404",
        description = "Terminvereinbarung nicht gefunden",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      )
    }
  )
  public TerminVereinbarungMessage putTerminAblehnen(@PathVariable String id) {
    TerminAblehnen command = new TerminAblehnen(new TerminVereinbarungsId(id));
    TerminVereinbarung terminVereinbarung =
      terminVereinbarungApplicationService.terminAblehnen(command);
    return TerminVereinbarungRestMessageMapper.mapToTerminVereinbarungMessage(terminVereinbarung);
  }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/vereinbarungen/TerminVereinbarungRestMessageMapper.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.vereinbarungen;
import de.cenglisch.rentalbackend.buchung.core.application.vereinbarungen.TerminAnfrageStellen;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarung;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminvereinbarungsZeitraum;
import de.cenglisch.rentalbackend.common.domain.StandortId;
import de.cenglisch.rentalbackend.kunde.api.domain.KundenId;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
public class TerminVereinbarungRestMessageMapper {
  private TerminVereinbarungRestMessageMapper() {
  }
  public static TerminAnfrageStellen mapToTerminAnfrageStellen(KundenId kundenId, TerminAnfrageMessage message) {
    return new TerminAnfrageStellen(
      kundenId,
      new FahrzeugId(message.fahrzeugId()),
      new TerminvereinbarungsZeitraum(message.von(), message.bis()),
      StandortId.von(message.standortId()),
      message.abholzeit(),
      message.rueckgabezeit()
    );
  }
  public static TerminVereinbarungMessage mapToTerminVereinbarungMessage(TerminVereinbarung terminVereinbarung) {
    return new TerminVereinbarungMessage(
      terminVereinbarung.getId().id(),
      terminVereinbarung.getKundenId().value(),
      terminVereinbarung.getFahrzeugId().id(),
      terminVereinbarung.getStatus(),
      terminVereinbarung.getZeitraum().von(),
      terminVereinbarung.getZeitraum().bis(),
      terminVereinbarung.getStandortId().id(),
      terminVereinbarung.getAbholzeit(),
      terminVereinbarung.getRueckgabezeit()
    );
  }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/verfuegbarkeiten/VerfuegbarkeitMessage.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.verfuegbarkeiten;
import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;
import java.util.Set;
public record VerfuegbarkeitMessage(
  @Schema(description = "Die ID des Verfügbarkeitskalenders", example = "a1b2c3d4-e5f6-7890-abcd-ef1234567890")
  String id,
  @Schema(description = "Die ID des Fahrzeugs", example = "f47ac10b-58cc-4372-a567-0e02b2c3d479")
  String fahrzeugId,
  @Schema(description = "Das Jahr des Kalenders", example = "2025")
  int jahr,
  @Schema(description = "Der Monat des Kalenders (1-12)", example = "11", minimum = "1", maximum = "12")
  int monat,
  @Schema(description = "Die Anzahl der reservierten Tage im Monat", example = "5")
  int anzahlReservierterTage,
  @Schema(description = "Liste der reservierten Tage",
    example = "[\"2025-11-15\", \"2025-11-16\", \"2025-11-17\"]")
  Set<LocalDate> reservierteTage
) {
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/verfuegbarkeiten/VerfuegbarkeitNotFoundException.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.verfuegbarkeiten;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ResponseStatus;
@ResponseStatus(HttpStatus.NOT_FOUND)
public class VerfuegbarkeitNotFoundException extends RuntimeException {
  public VerfuegbarkeitNotFoundException(String message) {
    super(message);
  }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/verfuegbarkeiten/VerfuegbarkeitRestAdapter.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.verfuegbarkeiten;
import de.cenglisch.rentalbackend.buchung.core.adapter.secondary.persistence.verfuegbarkeiten.VerfuegbarkeitsKalendarPersistenceAdapter;
import de.cenglisch.rentalbackend.buchung.core.domain.verfuebarkeiten.VerfuegbarkeitsKalendar;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.constraints.Max;
import jakarta.validation.constraints.Min;
import lombok.RequiredArgsConstructor;
import org.springframework.http.MediaType;
import org.springframework.http.ProblemDetail;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import java.time.Month;
import java.time.Year;
@RestController
@RequestMapping("/api/v1/verfuegbarkeit")
@RequiredArgsConstructor
@Validated
@Tag(name = "Verfügbarkeit", description = "Abfrage der Verfügbarkeit von Fahrzeugen")
public class VerfuegbarkeitRestAdapter {
  private final VerfuegbarkeitsKalendarPersistenceAdapter persistenceAdapter;
  @GetMapping("/{fahrzeugId}/{jahr}/{monat}")
  @Operation(
    summary = "Verfügbarkeitskalender abfragen",
    description = "Ruft den Verfügbarkeitskalender fuer ein bestimmtes Fahrzeug, Jahr und Monat ab. " +
      "Zeigt alle reservierten Tage im angegebenen Monat.",
    responses = {
      @ApiResponse(
        responseCode = "200",
        description = "Verfügbarkeitskalender wurde gefunden",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = VerfuegbarkeitMessage.class)
        )
      ),
      @ApiResponse(
        responseCode = "400",
        description = "Ungültige Parameter (z.B. Monat außerhalb 1-12)",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      ),
      @ApiResponse(
        responseCode = "404",
        description = "Kein Verfügbarkeitskalender fuer diesen Zeitraum gefunden",
        content = @Content(
          mediaType = MediaType.APPLICATION_JSON_VALUE,
          schema = @Schema(implementation = ProblemDetail.class)
        )
      )
    }
  )
  public VerfuegbarkeitMessage getVerfuegbarkeit(
    @Parameter(description = "Die ID des Fahrzeugs", example = "f47ac10b-58cc-4372-a567-0e02b2c3d479")
    @PathVariable String fahrzeugId,
    @Parameter(description = "Das Jahr", example = "2025")
    @PathVariable @Min(2000) @Max(2100) int jahr,
    @Parameter(description = "Der Monat (1-12)", example = "11")
    @PathVariable @Min(1) @Max(12) int monat
  ) {
    FahrzeugId fahrzeugIdObj = new FahrzeugId(fahrzeugId);
    Year jahrObj = Year.of(jahr);
    Month monatObj = Month.of(monat);
    VerfuegbarkeitsKalendar kalendar = persistenceAdapter
      .findByFahrzeugIdAndJahrAndMonat(fahrzeugIdObj, jahrObj, monatObj)
      .orElseThrow(() -> new VerfuegbarkeitNotFoundException(
        String.format("Kein Verfügbarkeitskalender gefunden fuer Fahrzeug %s im %s %d",
          fahrzeugId, monatObj.name(), jahr)
      ));
    return VerfuegbarkeitRestMessageMapper.mapToVerfuegbarkeitMessage(kalendar);
  }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/primary/rest/verfuegbarkeiten/VerfuegbarkeitRestMessageMapper.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.primary.rest.verfuegbarkeiten;
import de.cenglisch.rentalbackend.buchung.core.domain.verfuebarkeiten.VerfuegbarkeitsKalendar;
public class VerfuegbarkeitRestMessageMapper {
  private VerfuegbarkeitRestMessageMapper() {
  }
  public static VerfuegbarkeitMessage mapToVerfuegbarkeitMessage(VerfuegbarkeitsKalendar kalendar) {
    return new VerfuegbarkeitMessage(
      kalendar.getId().id(),
      kalendar.getFahrzeugId().id(),
      kalendar.getJahr().getValue(),
      kalendar.getMonat().getValue(),
      kalendar.anzahlReservierterTage(),
      kalendar.getReservierteTage()
    );
  }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/secondary/persistence/vereinbarungen/TerminVereinbarungEntity.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.secondary.persistence.vereinbarungen;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarungsStatus;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import java.time.LocalDate;
import java.time.LocalTime;
@Entity
@Table(name = "termin_vereinbarung")
@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class TerminVereinbarungEntity {
  @Id
  private String id;
  @Column(name = "kunden_id", nullable = false)
  private String kundenId;
  @Column(name = "fahrzeug_id", nullable = false)
  private String fahrzeugId;
  @Enumerated(EnumType.STRING)
  private TerminVereinbarungsStatus status;
  private LocalDate von;
  private LocalDate bis;
  @Column(name = "standort_id", nullable = false)
  private String standortId;
  @Column(name = "abholzeit")
  private LocalTime abholzeit;
  @Column(name = "rueckgabezeit")
  private LocalTime rueckgabezeit;
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/secondary/persistence/vereinbarungen/TerminVereinbarungJpaRepository.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.secondary.persistence.vereinbarungen;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarungsStatus;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.List;
@Repository
interface TerminVereinbarungJpaRepository extends JpaRepository<TerminVereinbarungEntity, String> {
  List<TerminVereinbarungEntity> findByKundenId(String kundenId);
  List<TerminVereinbarungEntity> findByFahrzeugId(String fahrzeugId);
  List<TerminVereinbarungEntity> findByStatus(TerminVereinbarungsStatus status);
  List<TerminVereinbarungEntity> findByFahrzeugIdAndStatus(String fahrzeugId, TerminVereinbarungsStatus status);
  List<TerminVereinbarungEntity> findByKundenIdAndStatus(String kundenId, TerminVereinbarungsStatus status);
  List<TerminVereinbarungEntity> findByKundenIdAndFahrzeugId(String kundenId, String fahrzeugId);
  List<TerminVereinbarungEntity> findByKundenIdAndFahrzeugIdAndStatus(String kundenId, String fahrzeugId, TerminVereinbarungsStatus status);
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/secondary/persistence/vereinbarungen/TerminVereinbarungMapper.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.secondary.persistence.vereinbarungen;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarung;
import de.cenglisch.rentalbackend.buchung.api.domain.vereinbarungen.TerminVereinbarungsId;
import de.cenglisch.rentalbackend.common.domain.StandortId;
import de.cenglisch.rentalbackend.common.domain.Zeitraum;
import de.cenglisch.rentalbackend.kunde.api.domain.KundenId;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
import org.springframework.stereotype.Component;
@Component
public class TerminVereinbarungMapper {
  public TerminVereinbarungEntity toEntity(TerminVereinbarung terminVereinbarung) {
    return TerminVereinbarungEntity.builder()
      .id(terminVereinbarung.getId().id())
      .kundenId(terminVereinbarung.getKundenId().value())
      .fahrzeugId(terminVereinbarung.getFahrzeugId().id())
      .status(terminVereinbarung.getStatus())
      .von(terminVereinbarung.getZeitraum().von())
      .bis(terminVereinbarung.getZeitraum().bis())
      .standortId(terminVereinbarung.getStandortId().id())
      .abholzeit(terminVereinbarung.getAbholzeit())
      .rueckgabezeit(terminVereinbarung.getRueckgabezeit())
      .build();
  }
  public TerminVereinbarung fromEntity(TerminVereinbarungEntity entity) {
    return new TerminVereinbarung(
      new TerminVereinbarungsId(entity.getId()),
      new KundenId(entity.getKundenId()),
      new FahrzeugId(entity.getFahrzeugId()),
      entity.getStatus(),
      new Zeitraum(entity.getVon(), entity.getBis()),
      StandortId.von(entity.getStandortId()),
      entity.getAbholzeit(),
      entity.getRueckgabezeit()
    );
  }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/secondary/persistence/vereinbarungen/TerminVereinbarungPersistenceAdapter.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.secondary.persistence.vereinbarungen;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarung;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarungRepository;
import de.cenglisch.rentalbackend.buchung.api.domain.vereinbarungen.TerminVereinbarungsId;
import de.cenglisch.rentalbackend.buchung.core.domain.vereinbarungen.TerminVereinbarungsStatus;
import de.cenglisch.rentalbackend.kunde.api.domain.KundenId;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import java.util.Collection;
import java.util.Optional;
@Component
@RequiredArgsConstructor
public class TerminVereinbarungPersistenceAdapter implements TerminVereinbarungRepository {
  private final TerminVereinbarungJpaRepository jpaRepository;
  private final TerminVereinbarungMapper mapper;
  @Override
  public TerminVereinbarung save(TerminVereinbarung terminVereinbarung) {
    TerminVereinbarungEntity entity = mapper.toEntity(terminVereinbarung);
    jpaRepository.save(entity);
    return terminVereinbarung;
  }
  @Override
  public Optional<TerminVereinbarung> findById(TerminVereinbarungsId id) {
    return jpaRepository.findById(id.id())
      .map(mapper::fromEntity);
  }
  @Override
  public void deleteById(TerminVereinbarungsId id) {
    jpaRepository.deleteById(id.id());
  }
  @Override
  public Collection<TerminVereinbarung> findAll() {
    return jpaRepository.findAll().stream()
      .map(mapper::fromEntity)
      .toList();
  }
  @Override
  public Collection<TerminVereinbarung> findByKundenId(KundenId kundenId) {
    return jpaRepository.findByKundenId(kundenId.value()).stream()
      .map(mapper::fromEntity)
      .toList();
  }
  @Override
  public Collection<TerminVereinbarung> findByStatus(TerminVereinbarungsStatus status) {
    return jpaRepository.findByStatus(status).stream()
      .map(mapper::fromEntity)
      .toList();
  }
  @Override
  public Collection<TerminVereinbarung> findByFahrzeugId(FahrzeugId fahrzeugId) {
    return jpaRepository.findByFahrzeugId(fahrzeugId.id()).stream()
      .map(mapper::fromEntity)
      .toList();
  }
  @Override
  public Collection<TerminVereinbarung> findByFahrzeugIdAndStatus(FahrzeugId fahrzeugId, TerminVereinbarungsStatus status) {
    return jpaRepository.findByFahrzeugIdAndStatus(fahrzeugId.id(), status).stream()
      .map(mapper::fromEntity)
      .toList();
  }
  @Override
  public Collection<TerminVereinbarung> findByKundenIdAndStatus(KundenId kundenId, TerminVereinbarungsStatus status) {
    return jpaRepository.findByKundenIdAndStatus(kundenId.value(), status).stream()
      .map(mapper::fromEntity)
      .toList();
  }
  @Override
  public Collection<TerminVereinbarung> findByKundenIdAndFahrzeugId(KundenId kundenId, FahrzeugId fahrzeugId) {
    return jpaRepository.findByKundenIdAndFahrzeugId(kundenId.value(), fahrzeugId.id()).stream()
      .map(mapper::fromEntity)
      .toList();
  }
  @Override
  public Collection<TerminVereinbarung> findByKundenIdAndFahrzeugIdAndStatus(KundenId kundenId, FahrzeugId fahrzeugId, TerminVereinbarungsStatus status) {
    return jpaRepository.findByKundenIdAndFahrzeugIdAndStatus(kundenId.value(), fahrzeugId.id(), status).stream()
      .map(mapper::fromEntity)
      .toList();
  }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/secondary/persistence/verfuegbarkeiten/VerfuegbarkeitsKalendarEntity.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.secondary.persistence.verfuegbarkeiten;
import jakarta.persistence.CollectionTable;
import jakarta.persistence.Column;
import jakarta.persistence.ElementCollection;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import java.time.LocalDate;
import java.util.HashSet;
import java.util.Set;
@Entity
@Table(name = "verfuegbarkeits_kalendar")
@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class VerfuegbarkeitsKalendarEntity {
    @Id
    private String id;
    @Column(name = "fahrzeug_id", nullable = false)
    private String fahrzeugId;
    @Column(name = "jahr", nullable = false)
    private int jahr;
    @Column(name = "monat", nullable = false)
    private int monat;
    @ElementCollection(fetch = FetchType.EAGER)
    @CollectionTable(
        name = "verfuegbarkeits_kalendar_reservierte_tage",
        joinColumns = @JoinColumn(name = "kalendar_id")
    )
    @Column(name = "reserviertes_datum")
    @Builder.Default
    private Set<LocalDate> reservierteTage = new HashSet<>();
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/secondary/persistence/verfuegbarkeiten/VerfuegbarkeitsKalendarJpaRepository.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.secondary.persistence.verfuegbarkeiten;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import java.util.Optional;
@Repository
interface VerfuegbarkeitsKalendarJpaRepository extends JpaRepository<VerfuegbarkeitsKalendarEntity, String> {
    @Query("""
        SELECT k FROM VerfuegbarkeitsKalendarEntity k
        WHERE k.fahrzeugId = :fahrzeugId
          AND k.jahr = :jahr
          AND k.monat = :monat
        """)
    Optional<VerfuegbarkeitsKalendarEntity> findByFahrzeugIdAndJahrAndMonat(
        @Param("fahrzeugId") String fahrzeugId,
        @Param("jahr") int jahr,
        @Param("monat") int monat
    );
    @Query("""
        SELECT CASE WHEN COUNT(k) > 0 THEN true ELSE false END
        FROM VerfuegbarkeitsKalendarEntity k
        WHERE k.fahrzeugId = :fahrzeugId
          AND k.jahr = :jahr
          AND k.monat = :monat
        """)
    boolean existsByFahrzeugIdAndJahrAndMonat(
        @Param("fahrzeugId") String fahrzeugId,
        @Param("jahr") int jahr,
        @Param("monat") int monat
    );
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/secondary/persistence/verfuegbarkeiten/VerfuegbarkeitsKalendarMapper.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.secondary.persistence.verfuegbarkeiten;
import de.cenglisch.rentalbackend.buchung.core.domain.verfuebarkeiten.VerfuegbarkeitsKalendar;
import de.cenglisch.rentalbackend.buchung.core.domain.verfuebarkeiten.VerfuegbarkeitsKalendarId;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
import org.springframework.stereotype.Component;
import java.time.Month;
import java.time.Year;
import java.util.HashSet;
@Component
public class VerfuegbarkeitsKalendarMapper {
    public VerfuegbarkeitsKalendarEntity toEntity(VerfuegbarkeitsKalendar kalendar) {
        return VerfuegbarkeitsKalendarEntity.builder()
            .id(kalendar.getId().id())
            .fahrzeugId(kalendar.getFahrzeugId().id())
            .jahr(kalendar.getJahr().getValue())
            .monat(kalendar.getMonat().getValue())
            .reservierteTage(new HashSet<>(kalendar.getReservierteTage()))
            .build();
    }
    public VerfuegbarkeitsKalendar fromEntity(VerfuegbarkeitsKalendarEntity entity) {
        return new VerfuegbarkeitsKalendar(
            new VerfuegbarkeitsKalendarId(entity.getId()),
            new FahrzeugId(entity.getFahrzeugId()),
            Year.of(entity.getJahr()),
            Month.of(entity.getMonat()),
            new HashSet<>(entity.getReservierteTage())
        );
    }
}
</file>

<file path="rental-backend/src/main/java/de/cenglisch/rentalbackend/buchung/core/adapter/secondary/persistence/verfuegbarkeiten/VerfuegbarkeitsKalendarPersistenceAdapter.java">
package de.cenglisch.rentalbackend.buchung.core.adapter.secondary.persistence.verfuegbarkeiten;
import de.cenglisch.rentalbackend.buchung.core.domain.verfuebarkeiten.VerfuegbarkeitsKalendar;
import de.cenglisch.rentalbackend.buchung.core.domain.verfuebarkeiten.VerfuegbarkeitsKalendarId;
import de.cenglisch.rentalbackend.buchung.core.domain.verfuebarkeiten.VerfuegbarkeitsKalendarRepository;
import de.cenglisch.rentalbackend.warenbestand.api.FahrzeugId;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import java.time.Month;
import java.time.Year;
import java.util.Collection;
import java.util.Optional;
@Component
@RequiredArgsConstructor
@Slf4j
public class VerfuegbarkeitsKalendarPersistenceAdapter implements VerfuegbarkeitsKalendarRepository {
    private final VerfuegbarkeitsKalendarJpaRepository jpaRepository;
    private final VerfuegbarkeitsKalendarMapper mapper;
    @Override
    public VerfuegbarkeitsKalendar save(VerfuegbarkeitsKalendar kalendar) {
        log.debug("Speichere VerfügbarkeitsKalender {} fuer Fahrzeug {} ({}-{})",
            kalendar.getId().id(),
            kalendar.getFahrzeugId().id(),
            kalendar.getJahr(),
            kalendar.getMonat()
        );
        VerfuegbarkeitsKalendarEntity entity = mapper.toEntity(kalendar);
        jpaRepository.save(entity);
        log.debug("VerfügbarkeitsKalender {} erfolgreich gespeichert mit {} reservierten Tagen",
            kalendar.getId().id(),
            kalendar.anzahlReservierterTage()
        );
        return kalendar;
    }
    @Override
    public Optional<VerfuegbarkeitsKalendar> findById(VerfuegbarkeitsKalendarId id) {
        log.debug("Suche VerfügbarkeitsKalender mit ID {}", id.id());
        return jpaRepository.findById(id.id())
            .map(entity -> {
                log.debug("VerfügbarkeitsKalender {} gefunden", id.id());
                return mapper.fromEntity(entity);
            });
    }
    @Override
    public void deleteById(VerfuegbarkeitsKalendarId id) {
        log.debug("Lösche VerfügbarkeitsKalender {}", id.id());
        jpaRepository.deleteById(id.id());
    }
    @Override
    public Collection<VerfuegbarkeitsKalendar> findAll() {
        log.debug("Lade alle VerfügbarkeitsKalender");
        return jpaRepository.findAll().stream()
            .map(mapper::fromEntity)
            .toList();
    }
    @Override
    public Optional<VerfuegbarkeitsKalendar> findByFahrzeugIdAndJahrAndMonat(
            FahrzeugId fahrzeugId,
            Year jahr,
            Month monat) {
        log.debug("Suche VerfügbarkeitsKalender fuer Fahrzeug {} im {}-{}",
            fahrzeugId.id(), jahr, monat);
        return jpaRepository.findByFahrzeugIdAndJahrAndMonat(
                fahrzeugId.id(),
                jahr.getValue(),
                monat.getValue()
            )
            .map(entity -> {
                VerfuegbarkeitsKalendar kalendar = mapper.fromEntity(entity);
                log.debug("VerfügbarkeitsKalender gefunden mit {} reservierten Tagen",
                    kalendar.anzahlReservierterTage());
                return kalendar;
            });
    }
    @Override
    public boolean existsByFahrzeugIdAndJahrAndMonat(
            FahrzeugId fahrzeugId,
            Year jahr,
            Month monat) {
        boolean exists = jpaRepository.existsByFahrzeugIdAndJahrAndMonat(
            fahrzeugId.id(),
            jahr.getValue(),
            monat.getValue()
        );
        log.debug("VerfügbarkeitsKalender fuer Fahrzeug {} im {}-{} existiert: {}",
            fahrzeugId.id(), jahr, monat, exists);
        return exists;
    }
}
</file>

<file path="rental-backend/src/main/resources/application-local.yml">
server:
  port: 8081
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/rental
    username: myuser
    password: secret
    driver-class-name: org.postgresql.Driver
    hikari:
      connection-timeout: 20000
      maximum-pool-size: 5
      minimum-idle: 2
      idle-timeout: 300000
      max-lifetime: 1200000
      auto-commit: true
  liquibase:
    contexts: local,development
    drop-first: false
  jpa:
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: validate
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:9000/application/o/express-sportwagen-frontend/
          jwk-set-uri: http://localhost:9000/application/o/express-sportwagen-frontend/jwks/
authentik:
  auth-server-url: http://localhost:9000
  application: express-sportwagen-frontend
  enrollment-flow-slug: express-sportwagen-enrollment-flow
  api-token: dev-rental-backend-api-token-change-in-production
bootstrap:
  fahrzeuge: true
logging:
  level:
    liquibase: INFO
    de.cenglisch.rentalbackend: DEBUG
    org.springframework.modulith: DEBUG
    org.springframework.modulith.events: DEBUG
    org.springframework.security: DEBUG
</file>

<file path="rental-backend/src/main/resources/application.yml">
spring:
  application:
    name: rental-backend
  profiles:
    active: local
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.yaml
    enabled: true
  aop:
    auto: true
    proxy-target-class: true
  jpa:
    open-in-view: false
    show-sql: false
    hibernate:
      ddl-auto: validate
  modulith:
    events:
      jdbc:
        archive:
          enabled: true
      republish-outstanding-events-on-restart: true
springdoc:
  api-docs:
    path: /api-docs
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    tags-sorter: alpha
    operations-sorter: alpha
    oauth:
      client-id: express-sportwagen-frontend
      use-pkce-with-authorization-code-grant: true
authentik:
  auth-server-url: http://localhost:9000
  application: express-sportwagen-frontend
  enrollment-flow-slug: express-sportwagen-enrollment-flow
  api-token: ${AUTHENTIK_API_TOKEN:}
server:
  port: 8081
</file>

</files>
